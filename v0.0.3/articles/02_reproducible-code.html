<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating Reproducible Code for teal Modules • teal</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating Reproducible Code for teal Modules">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">teal</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_getting_started.html">Getting Started with Teal</a>
    </li>
    <li>
      <a href="../articles/02_reproducible-code.html">Creating Reproducible Code for teal Modules</a>
    </li>
    <li>
      <a href="../articles/10_teal_design_and_implementation.html">Teal Design and Implementation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.roche.com/NEST/teal/tree/v0.0.3">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Creating Reproducible Code for teal Modules</h1>
                        <h4 class="author">Alex Wang</h4>
            
            <h4 class="date">2019-02-21</h4>
      
      
      <div class="hidden name"><code>02_reproducible-code.Rmd</code></div>

    </div>

    
    
<div id="note" class="section level2">
<h2 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h2>
<p>We are currently working on less involved alternative ways to create reproducible code.</p>
</div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette details how to create visualizations in a teal/Shiny app with a “Show R Code” button that provides the exact code to reproduce the displayed outputs with an R-session. The demonstration for spaghetti plot (see screenshot below) in this vignette uses dummy data.</p>
<p><br></p>
<p><img src="images/app_spaghetti.png" alt="Teal Spaghetti Plot" style="width: 100%;"><img src="images/show_rcode.png" alt="Show R Code for Spaghetti Plot" style="width: 100%;"></p>
<p><br></p>
<p><strong>Summary of steps:</strong></p>
<ol style="list-style-type: decimal">
<li><p>Create the static visualization (don’t think of it as being part of a Shiny app just yet)</p></li>
<li><p>Divide the analysis code into logical chunks and tag each chunk with either <em># <span class="citation">@start_&lt;chunkname</span>&gt;</em> and <em># <span class="citation">@end_&lt;chunkname</span>&gt;</em> in case of multi-line chunks, or <em># <span class="citation">@oneline_&lt;chunkname</span>&gt;</em> for single-line chunks</p></li>
<li><p>Convert the code chunks into a Shiny module by splitting them into <a href="https://shiny.rstudio.com/tutorial/lesson6/" title="Use reactive expressions">reactive</a> expressions</p></li>
<li><p>Incorporate dynamic plot encodings</p></li>
<li><p>Use <code>parse_code_chunks</code> to create the reproducible R code</p></li>
</ol>
<p>The <code>parse_code_chunks</code> function reads a R script file, and returns a named list with the tagged code chunks. The output from <code>parse_code_chunks</code> can then be used to create the code used to re-produce the data visualization (or output in general). For more details, please refer to the function documentation using <code><a href="../reference/parse_code_chunks.html">?parse_code_chunks</a></code>.</p>
<p>The advantage of parsing code chunks is that the code lives within the module script, which can be debugged as long as the VADs are made available, such as by saving from a Shiny session using <code>as_global</code> (see section on debugging).</p>
</div>
<div id="demonstration-on-spaghetti-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#demonstration-on-spaghetti-plot" class="anchor"></a>Demonstration on Spaghetti Plot</h2>
<div id="step-1-create-static-visualization" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1-create-static-visualization" class="anchor"></a>Step 1: Create Static Visualization</h3>
<p>The code to create the spaghetti plot is as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(teal)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>) <span class="co"># Ensures reproducible data produced</span>

<span class="co"># Generates dummy data</span>
ASL &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ASL"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)
ARS &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ARS"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)

<span class="co"># Apply filters to data</span>
ASL_FILTERED &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(ASL, STUDYID <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>)) 

ARS_FILTERED_ALONE &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(ARS, (ADY <span class="op">&gt;=</span><span class="st"> </span>0L <span class="op">&amp;</span><span class="st"> </span>ADY <span class="op">&lt;=</span><span class="st"> </span>250L)) <span class="co"># Filters</span>

ARS_FILTERED &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(<span class="dt">x =</span> ASL_FILTERED[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"USUBJID"</span>, <span class="st">"STUDYID"</span>)], 
                      <span class="dt">y =</span> ARS_FILTERED_ALONE, <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"USUBJID"</span>, <span class="st">"STUDYID"</span>), 
                      <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span>)

<span class="co"># Best Confirmed Overall Response</span>
ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)

<span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
<span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
  <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
    <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
    <span class="dt">y =</span> ANL_Response,
    <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
  ),
  <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
  <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
)

<span class="co"># Spaghetti Plot</span>
p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> STUDYID)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha=</span><span class="fl">0.4</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"STUDYID"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)

p</code></pre></div>
</div>
<div id="step-2-divide-the-code-into-logical-chunks" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2-divide-the-code-into-logical-chunks" class="anchor"></a>Step 2: Divide the Code into Logical Chunks</h3>
<p>The reason for dividing the code into chunks is that when we make the code reactive for Shiny, we want to re-calculate as little as possible when encodings and filter conditions are changed in the individual chunks.</p>
<p>One way to divide the above code for spaghetti plot into logical chunks is as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Load libraries and read in the data</p></li>
<li><p>Filter the data</p></li>
<li><p>Get the response values</p></li>
<li><p>Merge the data</p></li>
<li><p>Plot the data</p></li>
</ol>
<p>R code chunks can be tagged with <em># <span class="citation">@start_&lt;chunkname</span>&gt;</em> and <em># <span class="citation">@end_&lt;chunkname</span>&gt;</em>, or with <em># <span class="citation">@oneline_&lt;chunkname</span>&gt;</em> if we want to tag a single line. The code chunks should be given unique and descriptive names. We begin by tagging chunks 3 - 5:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(teal)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)

<span class="co"># Chunk #1</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>) <span class="co"># Ensures reproducible data produced</span>

<span class="co"># Generates dummy data</span>
ASL &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ASL"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)
ARS &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ARS"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)

<span class="co"># Chunk #2</span>
<span class="co"># Apply filters to data</span>
ASL_FILTERED &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(ASL, STUDYID <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>)) 

ARS_FILTERED_ALONE &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(ARS, (ADY <span class="op">&gt;=</span><span class="st"> </span>0L <span class="op">&amp;</span><span class="st"> </span>ADY <span class="op">&lt;=</span><span class="st"> </span>250L)) 

ARS_FILTERED &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(<span class="dt">x =</span> ASL_FILTERED[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"USUBJID"</span>, <span class="st">"STUDYID"</span>)], 
                      <span class="dt">y =</span> ARS_FILTERED_ALONE, <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"USUBJID"</span>, <span class="st">"STUDYID"</span>), 
                      <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span>)

<span class="co"># Chunk #3</span>
<span class="co"># @start_ANL_Response</span>
<span class="co"># Best Confirmed Overall Response</span>
ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)
<span class="co"># @end_ANL_Response</span>

<span class="co"># Chunk #4</span>
<span class="co"># @start_ANL</span>
<span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
<span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
  <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
    <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
    <span class="dt">y =</span> ANL_Response,
    <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
  ),
  <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
  <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
)
<span class="co"># @end_ANL</span>

<span class="co"># Chunk #5</span>
<span class="co"># @start_plot</span>
<span class="co"># Spaghetti Plot</span>
p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> STUDYID)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha=</span><span class="fl">0.4</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"STUDYID"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)
<span class="co"># @end_plot</span>

p</code></pre></div>
<p>In this demo, there are three named code chunks - <em>ANL_Response</em>, <em>ANL</em>, and <em>plot</em>. This code should run locally without needing the teal package and produce the desired plot as long as the VADs are available.</p>
<p>Note that we don’t need to tag chunk #1 as the header can be created using the <code>get_header</code> function in teal (see section on headers and filters). We also don’t need to tag chunk #2 as it can be created using the <code>get_filter_txt</code> function in teal.</p>
<p>Also note that each variable assignment (i.e. with <code>&lt;-</code>) is tagged as a separate code chunk. As a general rule of thumb, any variable assignment that reacts under user interactions should have its own code chunk. Saving the ggplot object makes it easier to add additional lines of code to modify it, as you will see in the later steps.</p>
</div>
<div id="step-3-transform-static-code-to-reactive-form-for-shiny-module" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3-transform-static-code-to-reactive-form-for-shiny-module" class="anchor"></a>Step 3: Transform Static Code to Reactive Form for Shiny Module</h3>
<p>We now take the above static R code and create a teal module that reacts to changes in data filtering using the filter side panel. Note that the teal module is in essence a Shiny module and we recommend reading this excellent Shiny documentation (<a href="https://shiny.rstudio.com/articles/modules.html" class="uri">https://shiny.rstudio.com/articles/modules.html</a>).</p>
<p>Below is the template for the spaghetti plot teal module script. It contains the following functions:</p>
<ul>
<li>
<code>module_spaghetti_chunks</code>: specifies the new tab item for the teal app<br>
</li>
<li>
<code>ui_spaghetti_chunks</code> and <code>srv_spaghetti_chunks</code>: the ui and server functions for the spaghetti plot Shiny module, respectively</li>
</ul>
<p>Additional arguments may be supplied to the above functions, but at a minimum, <code>module_spaghetti_chunks</code> should have the <code>label</code> argument, <code>ui_spaghetti_chunks</code> should have the <a href="https://shiny.rstudio.com/articles/modules.html" title="namespace for the module">id</a> argument, and <code>server_spaghetti_chunks</code> should have the <code>input</code>, <code>output</code>, <code>session</code> and <code>datasets</code> arguments.</p>
<p>Note that the code for getting the filtered datasets is now replaced with teal’s interactive data filtering functionality: <code>datasets$get_data("ASL", filtered = TRUE, reactive = TRUE)</code> and <code>datasets$get_data("ARS", filtered = TRUE, reactive = TRUE)</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Spaghetti Plot Teal Module</span>
tm_spaghetti &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">label =</span> <span class="st">"Spaghetti Plot"</span>) {

  <span class="kw"><a href="../reference/module.html">module</a></span>(
    <span class="dt">label =</span> label,
    <span class="dt">filters =</span> <span class="st">"ARS"</span>,
    <span class="dt">server =</span> srv_spaghetti_chunks,
    <span class="dt">ui =</span> ui_spaghetti_chunks
  )

}

ui_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(id) {

  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)

  <span class="kw"><a href="../reference/standard_layout.html">standard_layout</a></span>(
    <span class="dt">output =</span> <span class="kw">plotOutput</span>(<span class="kw">ns</span>(<span class="st">"plot"</span>))
  )
  
}

srv_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, datasets) {

  <span class="co"># Plot output</span>
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({
    
    <span class="co"># Filter Data</span>
    ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    
    <span class="co"># @start_ANL_Response</span>
    <span class="co"># Best Confirmed Overall Response</span>
    ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)
    <span class="co"># @end_ANL_Response</span>
    
    <span class="co"># @start_ANL</span>
    <span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
    <span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
    ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
      <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
        <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
        <span class="dt">y =</span> ANL_Response,
        <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
      ),
      <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
      <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
    )
    <span class="co"># @end_ANL</span>

    <span class="co"># @start_plot</span>
    <span class="co"># Spaghetti Plot</span>
    p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> STUDYID)) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">      </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"STUDYID"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)
    <span class="co"># @end_plot</span>

    p

  })
}</code></pre></div>
<p>Save the above script to a file named <code>spaghetti_plot.R</code>, then create an <code>app.R</code> file with the following code, and refer to the spaghetti plot script by its module label (i.e. <code>module_spaghetti_chunks(label = "spaghetti plot")</code> under the “analysis items” tab.</p>
<p>Note that the code for reading data (and loading libraries) is now saved in <code>app.R</code> as they are applied across the app, not just to the spaghetti plot module.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(teal)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/source">source</a></span>(<span class="st">'spaghetti_plot.R'</span>)

<span class="co"># Generating dummy data</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>)
  
ASL &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ASL"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)
ARS &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ARS"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)

## Initialize Teal
x &lt;-<span class="st"> </span>teal<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/teal/topics/init">init</a></span>(
  <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">ASL =</span> ASL, <span class="dt">ARS =</span> ARS),
  <span class="dt">modules =</span> <span class="kw"><a href="../reference/root_modules.html">root_modules</a></span>(
    <span class="kw"><a href="../reference/tm_data_table.html">tm_data_table</a></span>(),
    <span class="kw"><a href="../reference/tm_variable_browser.html">tm_variable_browser</a></span>(),
    <span class="kw">tm_spaghetti</span>(<span class="dt">label =</span> <span class="st">"Spaghetti Plot"</span>) <span class="co"># Spaghetti Plot module</span>
    )
  )

## Initiate Shiny App
<span class="kw">shinyApp</span>(<span class="dt">ui =</span> x<span class="op">$</span>ui, <span class="dt">server =</span> x<span class="op">$</span>server)</code></pre></div>
<p>Now you have a working Shiny app!</p>
<p>That is, evaluate the lines one-by-one, and after evaluating the <code>shinyApp</code> function call, the desired Shiny app should open.</p>
<p>Next, we optimize the server function by using reactive expressions so that not all of the code is re-ran every time the filters change.</p>
<p>To convert the static plot from Step 1 into a more interactive plot where the user can change the encodings dynamically, it is good practice to convert each code chunk into their own <a href="https://shiny.rstudio.com/tutorial/lesson6/" title="Use reactive expressions">reactive</a> forms in the <code>server</code> function, instead of having all the code chunks embedded within the <code>renderPlot</code> expression.</p>
<p>For example, take the <em>ANL</em> code chunk, which should be wrapped in its own reactive expression as it needs to be dynamically updated when users modify filter settings. Since ANL depends on ASL_FILTERED, ARS_FILTERED and ANL_Response datasets, we first also need to obtain those values and <a href="https://shiny.rstudio.com/articles/validation.html" title="Write error messages for your UI with validate">validate</a> these before they can be used in the analysis code. Here, ANL_Response is a reactive value from an earlier step, and we need to assign <code>ANL_Response &lt;-  ANL_Response()</code> so that we can refer to the dataset as <code>ANL_Response</code> directly, as in the static code (for purposes of producing the reproducible R code).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ANL &lt;-<span class="st"> </span><span class="kw">reactive</span>({
  
  <span class="co"># 1. Get dependent reactive values</span>
  ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
  ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    
  ANL_Response &lt;-<span class="st"> </span><span class="kw">ANL_Response</span>() <span class="co"># ANL_Response is a reactive expression</span>
  
  <span class="co"># 2. Validate if correct</span>
  <span class="kw">validate</span>(<span class="kw">need</span>(ASL_FILTERED, <span class="st">"Need ASL data"</span>))
  <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
  <span class="kw">validate</span>(<span class="kw">need</span>(ANL_Response, <span class="st">"Need ANL_Response dataset"</span>))
  
  <span class="co"># 3. Include executable analysis code</span>
  <span class="co"># @start_ANL</span>
  <span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
  <span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
  ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
    <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
      <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID),
      <span class="dt">y =</span> ANL_Response,
      <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
    ),
    <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
    <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
  )
  <span class="co"># @end_ANL</span>

  <span class="co"># 4. Return value</span>
  ANL
})</code></pre></div>
<p>Note the points 1 - 4 in the code above. We advise to build every reactive expression with that sequence:</p>
<ol style="list-style-type: decimal">
<li><p>Resolve reactive values</p></li>
<li><p>Validate required input</p></li>
<li><p>Perform the necessary computations of the reactive expression</p></li>
<li><p>Return the value (which has the same variable name as the reactive expression).</p></li>
</ol>
<p>After adding reactive expressions, the full code for the <code>server</code> function should look as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">srv_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, datasets) {

  ANL_Response &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    
    <span class="co"># @start_ANL_Response</span>
    <span class="co"># Best Confirmed Overall Response</span>
    ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)
    <span class="co"># @end_ANL_Response</span>
    
    ANL_Response
    
  })
  
  ANL &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ANL_Response &lt;-<span class="st"> </span><span class="kw">ANL_Response</span>()
    
    <span class="kw">validate</span>(<span class="kw">need</span>(ASL_FILTERED, <span class="st">"Need ASL data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ANL_Response, <span class="st">"Need ANL_Response dataset"</span>))
    
    <span class="co"># @start_ANL</span>
    <span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
    <span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
    ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
      <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
        <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
        <span class="dt">y =</span> ANL_Response,
        <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
      ),
      <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
      <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
    )
    <span class="co"># @end_ANL</span>
    
    ANL
    
  })
  
  <span class="co"># Plot output</span>
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({
    
    ANL &lt;-<span class="st"> </span><span class="kw">ANL</span>()
    
    <span class="co"># @start_plot</span>
    <span class="co"># Spaghetti Plot</span>
    p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> STUDYID)) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">      </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"STUDYID"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)
    <span class="co"># @end_plot</span>
    
    p
    
  })
}</code></pre></div>
</div>
<div id="step-4-incorporate-dynamic-plot-encodings" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4-incorporate-dynamic-plot-encodings" class="anchor"></a>Step 4: Incorporate Dynamic Plot Encodings</h3>
<p>There are two types of plot encodings that can be added for when rendering the plot - the type that does not require dynamically modifying the number of lines of code to display and the type that does.</p>
<p>The first kind is simpler. To include this type of encoding, simply add a new encoding Shiny control widget (<a href="https://shiny.rstudio.com/tutorial/lesson3" class="uri">https://shiny.rstudio.com/tutorial/lesson3</a>) to the <code>ui</code> function and refer to it within the executable code in <code>server</code>; no code chunks tags are required. For example, if we want to add a “color by” variable to determine how the lines on the plot are colored, with a drop-down menu with options users can choose from, then the code to implement this within the module would be as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tm_spaghetti &lt;-<span class="st"> </span><span class="cf">function</span>(label) {
  
  <span class="kw"><a href="../reference/module.html">module</a></span>(
    <span class="dt">label =</span> label,
    <span class="dt">filters =</span> <span class="st">"ARS"</span>,
    <span class="dt">server =</span> srv_spaghetti_chunks,
    <span class="dt">ui =</span> ui_spaghetti_chunks,
    <span class="dt">ui_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      <span class="dt">choices =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"STUDYID"</span>, <span class="st">"TRT01P"</span>, <span class="st">"TRT01A"</span>, <span class="st">"Response"</span>)
    )
  )
  
}

<span class="co"># Defaults to coloring by STUDYID</span>
ui_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(id, <span class="dt">color_by =</span> <span class="st">"STUDYID"</span>, choices) {
  
  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)
  
  <span class="kw"><a href="../reference/standard_layout.html">standard_layout</a></span>(
    <span class="dt">output =</span> <span class="kw">plotOutput</span>(<span class="kw">ns</span>(<span class="st">"plot"</span>)),
    <span class="dt">encoding =</span> <span class="kw">div</span>(
      tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Encodings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
      <span class="kw">selectInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_color_by"</span>), <span class="st">"Color by"</span>,
                  <span class="dt">choices =</span> choices,
                  <span class="dt">selected =</span> color_by)
    )
  )
  
}

srv_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, datasets) {

  ANL_Response &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    
    <span class="co"># @start_ANL_Response</span>
    <span class="co"># Best Confirmed Overall Response</span>
    ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)
    <span class="co"># @end_ANL_Response</span>
    
    ANL_Response
    
  })
  
  ANL &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ANL_Response &lt;-<span class="st"> </span><span class="kw">ANL_Response</span>()
    
    <span class="kw">validate</span>(<span class="kw">need</span>(ASL_FILTERED, <span class="st">"Need ASL data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ANL_Response, <span class="st">"Need ANL_Response dataset"</span>))
    
    <span class="co"># @start_ANL</span>
    <span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
    <span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
    ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
      <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
        <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
        <span class="dt">y =</span> ANL_Response,
        <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
      ),
      <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
      <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
    )
    <span class="co"># @end_ANL</span>
    
    ANL
    
  })
  
  <span class="co"># Plot output</span>
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({
    
    ANL &lt;-<span class="st"> </span><span class="kw">ANL</span>()

    var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by
    <span class="kw">validate</span>(<span class="kw">need</span>(var_color_by, <span class="st">"Need color by value"</span>))
    
    <span class="co"># @start_plot</span>
    <span class="co"># Spaghetti Plot</span>
    p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/get">get</a></span>(var_color_by))) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">      </span><span class="kw">labs</span>(<span class="dt">color =</span> var_color_by) <span class="op">+</span>
<span class="st">      </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)
    <span class="co"># @end_plot</span>
    
    p
    
  })
}</code></pre></div>
<p>If the code to display varies (i.e. included/excluded depending on user selection), then conditional statements need to be added to the executable code for the plot. For example, if we wish to add an option for plotting data points via a checkbox (in addition to the existing lines plotted), then the <code>ui</code> and <code>server</code> functions need to be further modified as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tm_spaghetti &lt;-<span class="st"> </span><span class="cf">function</span>(label) {
  
  <span class="kw"><a href="../reference/module.html">module</a></span>(
    <span class="dt">label =</span> label,
    <span class="dt">filters =</span> <span class="st">"ARS"</span>,
    <span class="dt">server =</span> srv_spaghetti_chunks,
    <span class="dt">ui =</span> ui_spaghetti_chunks,
    <span class="dt">ui_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      <span class="dt">choices =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"STUDYID"</span>, <span class="st">"TRT01P"</span>, <span class="st">"TRT01A"</span>, <span class="st">"Response"</span>)
    )
  )
  
}

<span class="co"># Defaults to coloring by STUDYID and no points plotted</span>
ui_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(id, <span class="dt">color_by =</span> <span class="st">"STUDYID"</span>, choices, <span class="dt">show_points =</span> <span class="ot">FALSE</span>) {
  
  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)
  
  
  <span class="kw"><a href="../reference/standard_layout.html">standard_layout</a></span>(
    <span class="dt">output =</span> <span class="kw">plotOutput</span>(<span class="kw">ns</span>(<span class="st">"plot"</span>)),
    <span class="dt">encoding =</span> <span class="kw">div</span>(
        tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Encodings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
        <span class="kw">selectInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_color_by"</span>), <span class="st">"Color by"</span>,
                    <span class="dt">choices =</span> choices,
                    <span class="dt">selected =</span> color_by),
        tags<span class="op">$</span><span class="kw">hr</span>(),
        tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Plot Settings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
        <span class="kw">checkboxInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_show_points"</span>), <span class="st">"show individual data points"</span>, <span class="dt">value =</span> show_points)
      )
  )
}

srv_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, datasets) {
  
  ANL_Response &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    
    <span class="co"># @start_ANL_Response</span>
    <span class="co"># Best Confirmed Overall Response</span>
    ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)
    <span class="co"># @end_ANL_Response</span>
    
    ANL_Response
    
  })
  
  ANL &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ANL_Response &lt;-<span class="st"> </span><span class="kw">ANL_Response</span>()
    
    <span class="kw">validate</span>(<span class="kw">need</span>(ASL_FILTERED, <span class="st">"Need ASL data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ANL_Response, <span class="st">"Need ANL_Response dataset"</span>))
    
    <span class="co"># @start_ANL</span>
    <span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
    <span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
    ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
      <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
        <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
        <span class="dt">y =</span> ANL_Response,
        <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
      ),
      <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
      <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
    )
    <span class="co"># @end_ANL</span>
    
    ANL
    
  })
  
  <span class="co"># Plot output</span>
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({
    
    ANL &lt;-<span class="st"> </span><span class="kw">ANL</span>()
    
    var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by
    <span class="kw">validate</span>(<span class="kw">need</span>(var_color_by, <span class="st">"Need color by value"</span>))
    
    show_points &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_show_points
    
    <span class="co"># @start_plot</span>
    <span class="co"># Spaghetti Plot</span>
    p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/get">get</a></span>(var_color_by))) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">      </span><span class="kw">labs</span>(<span class="dt">color =</span> var_color_by) <span class="op">+</span>
<span class="st">      </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)
    <span class="co"># @end_plot</span>
    
    
    <span class="co"># Detemines whether to add the line for adding points to plot</span>
    <span class="cf">if</span> (show_points) { <span class="co"># User wants to show data points</span>
      
      p &lt;-<span class="st"> </span>p <span class="op">+</span>
<span class="st">          </span><span class="co"># @oneline_showpoint</span>
<span class="st">          </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.8</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>)
        
    }
    
    p
    
  })
}</code></pre></div>
<p>Note the use of <em>@oneline</em> to tag the one-line code used for adding data points to the plot (the start and end tags may also be used here).</p>
</div>
<div id="step-5-create-the-reproducible-r-code" class="section level3">
<h3 class="hasAnchor">
<a href="#step-5-create-the-reproducible-r-code" class="anchor"></a>Step 5: Create the Reproducible R Code</h3>
<p>Within the module’s <code>ui</code> function, a <em>Show R Code</em> <a href="https://shiny.rstudio.com/articles/action-buttons.html" title="Use Action Buttons">action button</a> should be added to the encodings panel (in this example, the button has the id <code>show_rcode</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ui_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(id, <span class="dt">color_by =</span> <span class="st">"STUDYID"</span>, choices, <span class="dt">show_points =</span> <span class="ot">FALSE</span>) {
  
  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)
  
  <span class="kw"><a href="../reference/standard_layout.html">standard_layout</a></span>(
    <span class="dt">output =</span> <span class="kw">plotOutput</span>(<span class="kw">ns</span>(<span class="st">"plot"</span>)),
    <span class="dt">encoding =</span> <span class="kw">div</span>(
        tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Encodings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
        <span class="kw">selectInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_color_by"</span>), <span class="st">"Color by"</span>,
                    <span class="dt">choices =</span> choices,
                    <span class="dt">selected =</span> color_by),
        tags<span class="op">$</span><span class="kw">hr</span>(),
        tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Plot Settings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
        <span class="kw">checkboxInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_show_points"</span>), <span class="st">"show individual data points"</span>, <span class="dt">value =</span> show_points)
    ),
    <span class="dt">forms =</span> <span class="kw">actionButton</span>(<span class="kw">ns</span>(<span class="st">"show_rcode"</span>), <span class="st">"Show R Code"</span>, <span class="dt">width =</span> <span class="st">"100%"</span>)
  )
}</code></pre></div>
<p>Then, within the <code>server</code> function, an event on the “Show R Code” button will produce a modal dialog that displays the reproducible code whenever user clicks the button. Note the use of <code>get_rcode_header</code> (explained at the end of this section) and <code>get_filter_txt</code> to create the text for the header and the code for filtering datasets.</p>
<p>The file with the Shiny module script is passed to <code>parse_code_chunks</code> to obtain the analysis code chunks. The code chunks are put together in the desired order using <code>paste</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Produce R code</span>
<span class="kw">observeEvent</span>(input<span class="op">$</span>show_rcode, {
  
  <span class="co"># Header</span>
  str_head &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_rcode_header.html">get_rcode_header</a></span>(<span class="dt">title =</span> <span class="st">"Demo Spaghetti Plot"</span>,
                            <span class="dt">description =</span> <span class="st">"Demo used for the walkthrough on building a teal Shiny module with reproducible code"</span>)
  
  <span class="co"># Code for filtering datasets</span>
  str_filter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_filter_txt.html">get_filter_txt</a></span>(<span class="dt">datasets =</span> datasets)
  
  chunks &lt;-<span class="st"> </span><span class="kw"><a href="../reference/parse_code_chunks.html">parse_code_chunks</a></span>(<span class="st">"spaghetti_plot.R"</span>, <span class="dt">reindent =</span> <span class="ot">TRUE</span>)
  
  chunks_ANL_Response &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL_Response, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  chunks_ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  chunks_plot &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>plot, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    
  code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(str_head,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"set.seed(1)"</span>, 
                      <span class="st">"ASL &lt;- generate_sample_data('ASL', N = 1000)"</span>, 
                      <span class="st">"ARS &lt;- generate_sample_data('ARS', N = 1000)"</span>, <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>),
                str_filter,
                chunks_ANL_Response,
                chunks_ANL,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(chunks_plot, <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>, <span class="dt">collapse =</span> <span class="st">""</span>),
                <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)
    
  <span class="kw">showModal</span>(<span class="kw">modalDialog</span>(
    <span class="dt">title =</span> <span class="st">"R Code for the Current Spaghetti Plot"</span>,
    tags<span class="op">$</span><span class="kw">pre</span>(tags<span class="op">$</span><span class="kw">code</span>(<span class="dt">class=</span><span class="st">"R"</span>, code)),
    <span class="dt">easyClose =</span> <span class="ot">TRUE</span>,
    <span class="dt">size =</span> <span class="st">"l"</span>
  ))
  
})</code></pre></div>
<p>For plot encodings, again, the processing required depends on what type of plot encoding it is - the type that does not require dynamically modifying the number of lines of code to display (e.g. selecting the color variable) and the type that does (e.g. adding another graphical layer to a ggplot plot).</p>
<p>There are two methods of modifying the code text to incorporate the first type of encodings:</p>
<ol style="list-style-type: decimal">
<li><p>Assign the reactive encoding to a variable, and then refer to that variable in the static part of the reactive expression</p></li>
<li><p>Substitute the static code with the reactive encodings when generating the reproducible code.</p></li>
</ol>
<p>The first is perhaps easier for the coder to write, while the second method produces more readable code for users. With the second method, special care must be taken to ensure variable names are clearly distinguishable, as it relies on regular expression pattern matching. See below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">####### Method 1 #######
<span class="kw">observeEvent</span>(input<span class="op">$</span>show_rcode, {
  
  str_head &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_rcode_header.html">get_rcode_header</a></span>(<span class="dt">title =</span> <span class="st">"Demo Spaghetti Plot"</span>,
                            <span class="dt">description =</span> <span class="st">"Demo used for the walkthrough on building a teal Shiny module with reproducible code"</span>)
  
  str_filter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_filter_txt.html">get_filter_txt</a></span>(<span class="dt">datasets =</span> datasets)
  
  var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by <span class="co"># Obtains user input</span>
  
  chunks &lt;-<span class="st"> </span><span class="kw"><a href="../reference/parse_code_chunks.html">parse_code_chunks</a></span>(<span class="st">"spaghetti_plot.R"</span>, <span class="dt">reindent =</span> <span class="ot">TRUE</span>)
    
  chunks_ANL_Response &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL_Response, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  chunks_ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  chunks_plot &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>plot, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  
  code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(str_head,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"set.seed(1)"</span>, 
                      <span class="st">"ASL &lt;- generate_sample_data('ASL', N = 1000)"</span>, 
                      <span class="st">"ARS &lt;- generate_sample_data('ARS', N = 1000)"</span>, <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>),
                str_filter,
                chunks_ANL_Response,
                chunks_ANL,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"var_color_by &lt;- '"</span>, var_color_by, <span class="st">"'"</span>), 
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(chunks_plot, <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>, <span class="dt">collapse =</span> <span class="st">""</span>),
                <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)
    
  <span class="kw">showModal</span>(<span class="kw">modalDialog</span>(
    <span class="dt">title =</span> <span class="st">"R Code for the Current Spaghetti Plot"</span>,
    tags<span class="op">$</span><span class="kw">pre</span>(tags<span class="op">$</span><span class="kw">code</span>(<span class="dt">class=</span><span class="st">"R"</span>, code)),
    <span class="dt">easyClose =</span> <span class="ot">TRUE</span>,
    <span class="dt">size =</span> <span class="st">"l"</span>
  ))
  
})


####### Method 2 #######
<span class="kw">observeEvent</span>(input<span class="op">$</span>show_rcode, {
  
  str_head &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_rcode_header.html">get_rcode_header</a></span>(<span class="dt">title =</span> <span class="st">"Demo Spaghetti Plot"</span>,
                            <span class="dt">description =</span> <span class="st">"Demo used for the walkthrough on building a teal Shiny module with reproducible code"</span>)
  
  str_filter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_filter_txt.html">get_filter_txt</a></span>(<span class="dt">datasets =</span> datasets)
  
  var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by <span class="co"># Obtains user input</span>
  
  chunks &lt;-<span class="st"> </span><span class="kw"><a href="../reference/parse_code_chunks.html">parse_code_chunks</a></span>(<span class="st">"spaghetti_plot.R"</span>, <span class="dt">reindent =</span> <span class="ot">TRUE</span>)
  
  <span class="co"># Update code for plot to replace text containing references to var_color_by with its value</span>
  chunks_plot &lt;-<span class="st"> </span>chunks<span class="op">$</span>plot <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"get[(]var_color_by[)]"</span>, var_color_by, .) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"var_color_by"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"'"</span>, var_color_by, <span class="st">"'"</span>), .)
    
  chunks_ANL_Response &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL_Response, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  chunks_ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
  chunks_plot &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks_plot, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    
  code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(str_head,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"set.seed(1)"</span>, 
                      <span class="st">"ASL &lt;- generate_sample_data('ASL', N = 1000)"</span>, 
                      <span class="st">"ARS &lt;- generate_sample_data('ARS', N = 1000)"</span>, <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>),
                str_filter,
                chunks_ANL_Response,
                chunks_ANL,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"var_color_by &lt;- '"</span>, var_color_by, <span class="st">"'"</span>), <span class="co"># Add new line to show var_color_by variable assignment</span>
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(chunks_plot, <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>, <span class="dt">collapse =</span> <span class="st">""</span>),
                <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)
  
  code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(str_head,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"set.seed(1)"</span>, 
                      <span class="st">"ASL &lt;- generate_sample_data('ASL', N = 1000)"</span>, 
                      <span class="st">"ARS &lt;- generate_sample_data('ARS', N = 1000)"</span>, <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>),
                str_filter,
                chunks_ANL_Response,
                chunks_ANL,
                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(chunks_plot, <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>, <span class="dt">collapse =</span> <span class="st">""</span>),
                <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)
  
  <span class="kw"><a href="../reference/showRCodeModal.html">showRCodeModal</a></span>(
    <span class="dt">title =</span> <span class="st">"R Code for the Current Spaghetti Plot"</span>,
    <span class="dt">rcode =</span> code
  )

})</code></pre></div>
<p>When the code to display depends on user specifications, conditional code text are needed, as illustrated below for the show_points encoding example, where the <em>showpoint</em> code chunk is included only if the show_points option is selected:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">observeEvent</span>(input<span class="op">$</span>show_rcode, {
  
    str_head &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_rcode_header.html">get_rcode_header</a></span>(<span class="dt">title =</span> <span class="st">"Demo Spaghetti Plot"</span>,
                              <span class="dt">description =</span> <span class="st">"Demo used for the walkthrough on building a teal Shiny module with reproducible code"</span>)
  
    str_filter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_filter_txt.html">get_filter_txt</a></span>(<span class="dt">datasets =</span> datasets)
    
    var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by
    
    show_points &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_show_points
    
    chunks &lt;-<span class="st"> </span><span class="kw"><a href="../reference/parse_code_chunks.html">parse_code_chunks</a></span>(<span class="st">"spaghetti_plot.R"</span>, <span class="dt">reindent =</span> <span class="ot">TRUE</span>)
    
    ll &lt;-<span class="st"> </span>chunks<span class="op">$</span>plot[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(chunks<span class="op">$</span>plot)] <span class="co"># Last line of the plot code chunk</span>
    ll_indent &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nchar">nchar</a></span>(ll) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nchar">nchar</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"^[[:space:]]*"</span>, <span class="st">""</span>, ll)) <span class="co"># Count amount of indentation needed </span>
    
    
    chunks_ANL_Response &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL_Response, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    chunks_ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    chunks_plot &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>plot, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    
    code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(str_head,
                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"set.seed(1)"</span>, 
                        <span class="st">"ASL &lt;- generate_sample_data('ASL', N = 1000)"</span>, 
                        <span class="st">"ARS &lt;- generate_sample_data('ARS', N = 1000)"</span>, <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>),
                  str_filter,
                  chunks_ANL_Response,
                  chunks_ANL,
                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"var_color_by &lt;- '"</span>, var_color_by, <span class="st">"'"</span>),
                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(show_points, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks_plot, <span class="st">" +</span><span class="ch">\n</span><span class="st">"</span>,
                                             <span class="kw"><a href="../reference/reindent.html">reindent</a></span>(chunks<span class="op">$</span>showpoint, ll_indent),
                                             <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>),
                         <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks_plot, <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>)),
                  <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)
    
    
    <span class="kw"><a href="../reference/showRCodeModal.html">showRCodeModal</a></span>(
      <span class="dt">title =</span> <span class="st">"R Code for the Current Spaghetti Plot"</span>,
      <span class="dt">rcode =</span> code
    )

})</code></pre></div>
</div>
<div id="get_rcode_header-function" class="section level3">
<h3 class="hasAnchor">
<a href="#get_rcode_header-function" class="anchor"></a><code>get_rcode_header</code> function</h3>
<p>The <code>get_rcode_header</code> function takes in the title, description (e.g. link to the Shiny app), packages/libraries needed, (optional) git repository of where the code is stored, and (optional) code lines (as a character vector, one element per dataset) for reading in the data needed for the module, and conveniently returns a single string containing the header text for the analysis item.</p>
<p>If the datasets used are not from <em>“/opt/BIOSTAT/…”</em>, then <code>get_rcode_header</code> would not generate the code for reading in the data, so users need to manually add those lines when putting together the code chunks to display, as demonstrated here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ASL &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ASL"</span>, <span class="dt">N =</span> <span class="dv">10</span>)
ARS &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ARS"</span>, <span class="dt">N =</span> <span class="dv">10</span>)

<span class="co"># The call produces the header text below</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="../reference/get_rcode_header.html">get_rcode_header</a></span>(
  <span class="dt">title =</span> <span class="st">"Demo Spaghetti Plot"</span>,
  <span class="dt">description =</span> <span class="st">"Demo used for the walkthrough on building a teal Shiny module with reproducible code"</span>,
  <span class="dt">libraries =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"ggplot2"</span>, <span class="st">"dplyr"</span>, <span class="st">"haven"</span>),
  <span class="dt">git_repo =</span> <span class="st">"https://github.roche.com/Rpackages/teal"</span>,
  <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">ASL =</span> ASL, <span class="dt">ARS=</span>ARS)
))</code></pre></div>
<pre><code># Demo Spaghetti Plot
# 
# Demo used for the walkthrough on building a teal Shiny module with reproducible code
# 
# Module Source: https://github.roche.com/Rpackages/teal
# Git-commit Shiny App: -
# Date: Thu Feb 21 17:13:27 2019
# 
# You can run this code interactively in http://r.roche.com

library(ggplot2)
library(dplyr)
library(haven)

ASL &lt;- generate_sample_data('ASL')  # md5sum at time of analysis: -
ARS &lt;- generate_sample_data('ARS')  # md5sum at time of analysis: -</code></pre>
</div>
<div id="complete-scripts" class="section level3">
<h3 class="hasAnchor">
<a href="#complete-scripts" class="anchor"></a>Complete Scripts</h3>
<p>To recap, here is the complete script for the spaghetti plot demo module:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tm_spaghetti &lt;-<span class="st"> </span><span class="cf">function</span>(label) {
  
  <span class="kw"><a href="../reference/module.html">module</a></span>(
    <span class="dt">label =</span> label,
    <span class="dt">filters =</span> <span class="st">"ARS"</span>,
    <span class="dt">server =</span> srv_spaghetti_chunks,
    <span class="dt">ui =</span> ui_spaghetti_chunks,
    <span class="dt">ui_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      <span class="dt">choices =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"STUDYID"</span>, <span class="st">"TRT01P"</span>, <span class="st">"TRT01A"</span>, <span class="st">"Response"</span>)
    )
  )
  
}

ui_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(id, <span class="dt">color_by =</span> <span class="st">"STUDYID"</span>, choices, <span class="dt">show_points =</span> <span class="ot">FALSE</span>) {
  
  ns &lt;-<span class="st"> </span><span class="kw">NS</span>(id)
  
  <span class="kw"><a href="../reference/standard_layout.html">standard_layout</a></span>(
    <span class="dt">output =</span> <span class="kw">plotOutput</span>(<span class="kw">ns</span>(<span class="st">"plot"</span>)),
    <span class="dt">encoding =</span> <span class="kw">div</span>(
        tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Encodings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
        <span class="kw">selectInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_color_by"</span>), <span class="st">"Color by"</span>,
                    <span class="dt">choices =</span> choices,
                    <span class="dt">selected =</span> color_by),
        tags<span class="op">$</span><span class="kw">hr</span>(),
        tags<span class="op">$</span><span class="kw">label</span>(<span class="st">"Plot Settings"</span>, <span class="dt">class =</span> <span class="st">"text-primary"</span>),
        <span class="kw">checkboxInput</span>(<span class="kw">ns</span>(<span class="st">"spaghetti_show_points"</span>), <span class="st">"show individual data points"</span>, <span class="dt">value =</span> show_points)
    ),
    <span class="dt">forms =</span> <span class="kw">actionButton</span>(<span class="kw">ns</span>(<span class="st">"show_rcode"</span>), <span class="st">"Show R Code"</span>, <span class="dt">width =</span> <span class="st">"100%"</span>)
  )
}

srv_spaghetti_chunks &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, datasets) {

    ANL_Response &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    
    <span class="co"># @start_ANL_Response</span>
    <span class="co"># Best Confirmed Overall Response</span>
    ANL_Response &lt;-<span class="st"> </span>ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "BESRSPI"</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">transmute</span>(<span class="dt">Response =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(AVALC, <span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CR"</span>, <span class="st">"PR"</span>, <span class="st">"SD"</span>, <span class="st">"PD"</span>, <span class="st">"NE"</span>)), <span class="dt">USUBJID=</span>USUBJID)
    <span class="co"># @end_ANL_Response</span>
    
    ANL_Response
    
  })
  
  ANL &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    
    ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>)
    ANL_Response &lt;-<span class="st"> </span><span class="kw">ANL_Response</span>()
    
    <span class="kw">validate</span>(<span class="kw">need</span>(ASL_FILTERED, <span class="st">"Need ASL data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ARS_FILTERED, <span class="st">"Need ARS data"</span>))
    <span class="kw">validate</span>(<span class="kw">need</span>(ANL_Response, <span class="st">"Need ANL_Response dataset"</span>))
    
    <span class="co"># @start_ANL</span>
    <span class="co"># Create Analysis Dataset for Spaghetti Plot</span>
    <span class="co"># PARAMCD == "CHSLD" for: Sum of Longest Diameter - Change from Baseline by Investigator</span>
    ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
      <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/merge">merge</a></span>(
        <span class="dt">x =</span> ASL_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, STUDYID, TRT01P, TRT01A),
        <span class="dt">y =</span> ANL_Response,
        <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">TRUE</span>, <span class="dt">all.y =</span> <span class="ot">FALSE</span> <span class="co"># response should not filter the data unnecessarily</span>
      ),
      <span class="dt">y =</span> ARS_FILTERED <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(PARAMCD <span class="op">==</span><span class="st"> "CHSLD"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(USUBJID, PARAM, PARAMCD, AVAL, ADY),
      <span class="dt">by =</span> <span class="st">"USUBJID"</span>, <span class="dt">all.x =</span> <span class="ot">FALSE</span>, <span class="dt">all.y =</span> <span class="ot">TRUE</span>
    )
    <span class="co"># @end_ANL</span>
    
    ANL
    
  })
  
  <span class="co"># Plot output</span>
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlot</span>({
    
    ANL &lt;-<span class="st"> </span><span class="kw">ANL</span>()
    
    var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by
    <span class="kw">validate</span>(<span class="kw">need</span>(var_color_by, <span class="st">"Need color by value"</span>))
    
    show_points &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_show_points
    
    <span class="co"># @start_plot</span>
    <span class="co"># Spaghetti Plot</span>
    p &lt;-<span class="st"> </span>ANL <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> ADY, <span class="dt">y =</span> AVAL, <span class="dt">group =</span> USUBJID, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/get">get</a></span>(var_color_by))) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">xlab</span>(<span class="st">"Analysis Study Day (ARS.ADY)"</span>) <span class="op">+</span>
<span class="st">      </span><span class="kw">ylab</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(ANL<span class="op">$</span>PARAM)) <span class="op">+</span>
<span class="st">      </span><span class="kw">labs</span>(<span class="dt">color =</span> var_color_by) <span class="op">+</span>
<span class="st">      </span><span class="kw">theme_light</span>(<span class="dt">base_size =</span> <span class="dv">14</span>)
    <span class="co"># @end_plot</span>
    
    <span class="cf">if</span> (show_points) {
      
      p &lt;-<span class="st"> </span>p <span class="op">+</span>
<span class="st">        </span><span class="co"># @oneline_showpoint</span>
<span class="st">        </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.8</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>)
  
    } 
    
    p
    
  })

  
  <span class="co"># Produce R Code</span>
  <span class="kw">observeEvent</span>(input<span class="op">$</span>show_rcode, {
    
    str_head &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_rcode_header.html">get_rcode_header</a></span>(<span class="dt">title =</span> <span class="st">"Demo Spaghetti Plot"</span>,
                              <span class="dt">description =</span> <span class="st">"Demo used for the walkthrough on building a teal Shiny module with reproducible code"</span>)
    
    str_filter &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_filter_txt.html">get_filter_txt</a></span>(<span class="dt">datasets =</span> datasets)
    
    var_color_by &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_color_by
    
    show_points &lt;-<span class="st"> </span>input<span class="op">$</span>spaghetti_show_points
    
    chunks &lt;-<span class="st"> </span><span class="kw"><a href="../reference/parse_code_chunks.html">parse_code_chunks</a></span>(<span class="st">"spaghetti_plot.R"</span>, <span class="dt">reindent =</span> <span class="ot">TRUE</span>)
    
    chunks_plot &lt;-<span class="st"> </span>chunks<span class="op">$</span>plot <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"get[(]var_color_by[)]"</span>, var_color_by, .) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"var_color_by"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"'"</span>, var_color_by, <span class="st">"'"</span>), .)
    
    ll &lt;-<span class="st"> </span>chunks<span class="op">$</span>plot[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(chunks<span class="op">$</span>plot)] 
    ll_indent &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nchar">nchar</a></span>(ll) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nchar">nchar</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"^[[:space:]]*"</span>, <span class="st">""</span>, ll)) 
    
    
    chunks_ANL_Response &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL_Response, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    chunks_ANL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks<span class="op">$</span>ANL, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    chunks_plot &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks_plot, <span class="dt">collapse =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
    
    code &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(str_head,
                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"set.seed(1)"</span>, 
                        <span class="st">"ASL &lt;- generate_sample_data('ASL', N = 1000)"</span>, 
                        <span class="st">"ARS &lt;- generate_sample_data('ARS', N = 1000)"</span>, <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>),
                  str_filter,
                  chunks_ANL_Response,
                  chunks_ANL,
                  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(show_points, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks_plot, <span class="st">" +</span><span class="ch">\n</span><span class="st">"</span>,
                                             <span class="kw"><a href="../reference/reindent.html">reindent</a></span>(chunks<span class="op">$</span>showpoint, ll_indent),
                                             <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>),
                         <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(chunks_plot, <span class="st">"</span><span class="ch">\n</span><span class="st">p"</span>)),
                  <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)
    
    <span class="kw"><a href="../reference/showRCodeModal.html">showRCodeModal</a></span>(
      <span class="dt">title =</span> <span class="st">"R Code for the Current Spaghetti Plot"</span>,
      <span class="dt">rcode =</span> code
    )
}</code></pre></div>
<p>And here is the content of the <code>app.R</code> script:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(teal)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/source">source</a></span>(<span class="st">'spaghetti_plot.R'</span>)

<span class="co"># Generating dummy data</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1</span>)
  
ASL &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ASL"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)
ARS &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_sample_data.html">generate_sample_data</a></span>(<span class="st">"ARS"</span>, <span class="dt">N =</span> <span class="dv">1000</span>)

## Initialize Teal
x &lt;-<span class="st"> </span>teal<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/teal/topics/init">init</a></span>(
  <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">ASL =</span> ASL, <span class="dt">ARS =</span> ARS),
  <span class="dt">modules =</span> <span class="kw"><a href="../reference/root_modules.html">root_modules</a></span>(
    <span class="kw"><a href="../reference/tm_data_table.html">tm_data_table</a></span>(),
    <span class="kw"><a href="../reference/tm_variable_browser.html">tm_variable_browser</a></span>(),
    <span class="kw">tm_spaghetti</span>(<span class="dt">label =</span> <span class="st">"Spaghetti Plot"</span>) <span class="co"># Spaghetti Plot module</span>
  )
)

## Initiate Shiny App
<span class="kw">shinyApp</span>(<span class="dt">ui =</span> x<span class="op">$</span>ui, <span class="dt">server =</span> x<span class="op">$</span>server)</code></pre></div>
</div>
</div>
<div id="debugging" class="section level2">
<h2 class="hasAnchor">
<a href="#debugging" class="anchor"></a>Debugging</h2>
<p>The <code>as.global</code> function (part of the <code>teal</code> package) can be used to save VADs and other values of reactive expressions from an active teal Shiny app session into the user’s workspace, so that these variables are available for inspection after the app has closed. The data can then be used for line-by-line debugging. To use <code>as.global</code>, insert the following code into the <code>server</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">observe</span>({
  
  ANL_Response &lt;-<span class="st"> </span><span class="kw">ANL_Response</span>()
  ASL_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ASL"</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>)
  ARS_FILTERED &lt;-<span class="st"> </span>datasets<span class="op">$</span><span class="kw">get_data</span>(<span class="st">"ARS"</span>, <span class="dt">reactive =</span> <span class="ot">TRUE</span>, <span class="dt">filtered =</span> <span class="ot">TRUE</span>)
  ANL &lt;-<span class="st"> </span><span class="kw">ANL</span>()
    
  teal<span class="op">:::</span><span class="kw"><a href="../reference/as.global.html">as.global</a></span>(ANL_Response)
  teal<span class="op">:::</span><span class="kw"><a href="../reference/as.global.html">as.global</a></span>(ASL_FILTERED)
  teal<span class="op">:::</span><span class="kw"><a href="../reference/as.global.html">as.global</a></span>(ARS_FILTERED)
  teal<span class="op">:::</span><span class="kw"><a href="../reference/as.global.html">as.global</a></span>(ANL)
  
})</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#note">Note</a></li>
      <li><a href="#introduction">Introduction</a></li>
      <li><a href="#demonstration-on-spaghetti-plot">Demonstration on Spaghetti Plot</a></li>
      <li><a href="#debugging">Debugging</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adrian Waddell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
